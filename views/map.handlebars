{{#section 'head'}}
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.31.0/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.31.0/mapbox-gl.css' rel='stylesheet' />
<style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
{{/section}}

<style>
#origin_marker {
    width: 10px;
    height: 10px;
    background: red;
    -moz-border-radius: 5px;
    -webkit-border-radius: 5px;
    border-radius: 5px;
}
#destination_marker {
    width: 10px;
    height: 10px;
    background: blue;
    -moz-border-radius: 5px;
    -webkit-border-radius: 5px;
    border-radius: 5px;
}
</style>
<div id='map'></div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoieWluYXpodSIsImEiOiJjaXljbDM5ZjMwMTlvMnBwOTk5MnJtZzcyIn0.qy8pHJnT4fYeu1zGkYEclA';
var map = new mapboxgl.Map({
  container: 'map', // container id
  style: 'mapbox://styles/mapbox/streets-v9', //stylesheet location
  center: [-122.311981244013,47.6606906634709], // starting position
  zoom: 15 // starting zoom
});
map.once('load', function load() {
  // add source and layer 'route' to map as long as map is loaded
  // data of 'source' is initialized with empty features
  // and will be updated when getRoute returns a route
  map.addSource('route', {
    type: 'geojson',
    data: {
      "type": "FeatureCollection",
      "features": []
    }
  });
  map.addLayer({
    "id": "route",
    "type": "line",
    "source": "route",
    "layout": {
      "line-join": "round",
      "line-cap": "round"
    },
    "paint": {
      "line-color": "#888",
      "line-width": 8
    }
  });
});
// keeps track of geoJSON of origin point
var origin
// geoJSON of destination point
var destination
// popup asking whether current point is set to origin or destination
var contextPopup
// origin and destination markers initialized with LngLat [0,0]
var el_origin = document.createElement('div');
el_origin.id = 'origin_marker';
var origin_marker = new mapboxgl.Marker(el_origin)
  .setLngLat([0, 0])
  .addTo(map);
var el_destination = document.createElement('div');
el_destination.id = 'destination_marker';
var destination_marker = new mapboxgl.Marker(el_destination)
  .setLngLat([0, 0])
  .addTo(map);
// when right click happens display a popup
map.on('contextmenu', function (e) {
  let html = `
    <div id="contextmenu">
    <ul style="list-style-type: none; padding-left: 0;">
    <li id="origin">
      <a>Set Origin</a>
    </li>
    <li id="destination">
      <a>Set Destination</a>
    </li>
    </ul>
    </div>
  `;
  contextPopup = new mapboxgl.Popup();
  contextPopup.setLngLat(e.lngLat)
    .setHTML(html)
    .addTo(map);
  // Set up listeners for click events
  let originEl = document.getElementById('origin');
  let destinationEl = document.getElementById('destination');
  // update origin marker and get route if destination is also set
  originEl.addEventListener('click', () => {
    origin = {"type":"Point","coordinates":[e.lngLat.lng, e.lngLat.lat]};
    origin_marker.setLngLat([e.lngLat.lng, e.lngLat.lat]);
    if (origin && destination) {
      getRoute(origin, destination);
    }
    contextPopup.remove();
  });
  // update destination marker and get route if origin is also set
  destinationEl.addEventListener('click', () => {
    destination = {"type":"Point","coordinates":[e.lngLat.lng, e.lngLat.lat]};
    destination_marker.setLngLat([e.lngLat.lng, e.lngLat.lat]);
    if (origin && destination) {
      getRoute(origin, destination);
    }
    contextPopup.remove();
  });
});

// function that send POST request with coordinates of two points
// to backend and update the data of "route" with routes info in the response
function getRoute(source_geom, target_geom) {
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/getRoute/', true)
  // update "route" accroding to response
  xhr.addEventListener('load', function (e) {
    var xhr = e.target;
    if (xhr.status == 200) {
      var features = JSON.parse(xhr.response);
      console.log(features);
      // loop through each edge in the route
      for (i = 0; i < features.length; i++) {
        features[i] = {
	  "type": "Feature",
          "properties": {},
          "geometry": JSON.parse(features[i])
        }
      }
      // update 'route' source
      map.getSource('route').setData({
        "type": "FeatureCollection",
        "features": features
      });
    }
  });
  // send request with stringified JSON of two points
  xhr.setRequestHeader("Content-Type", "application/json");
  var body = JSON.stringify({"source": JSON.stringify(source_geom),
                             "target": JSON.stringify(target_geom)})
  console.log(body)
  xhr.send(body)
}
</script>
